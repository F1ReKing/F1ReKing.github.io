<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="勿忘初心"><title>内存泄漏解析 | F1ReKing Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">内存泄漏解析</h1><a id="logo" href="/.">F1ReKing Blog</a><p class="description">Be the change you want to see in the world.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">内存泄漏解析</h1><div class="post-meta">Mar 1, 2017<span> | </span><span class="category"><a href="/categories/理-理论学习/">理.理论学习</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="2017/03/01/memory-leak-analysis/" href="/2017/03/01/memory-leak-analysis/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#杂谈"><span class="toc-number">2.</span> <span class="toc-text">杂谈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存泄漏解析"><span class="toc-number">3.</span> <span class="toc-text">内存泄漏解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-持有Context"><span class="toc-number">3.1.</span> <span class="toc-text">1.持有Context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Handler"><span class="toc-number">3.2.</span> <span class="toc-text">2.Handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-单例模式"><span class="toc-number">3.3.</span> <span class="toc-text">3.单例模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-非静态内部类创建静态实例"><span class="toc-number">3.4.</span> <span class="toc-text">4.非静态内部类创建静态实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-线程"><span class="toc-number">3.5.</span> <span class="toc-text">5.线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-资源未关闭"><span class="toc-number">3.6.</span> <span class="toc-text">6.资源未关闭</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-监听器未注销"><span class="toc-number">3.7.</span> <span class="toc-text">7.监听器未注销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-WebView"><span class="toc-number">3.8.</span> <span class="toc-text">8.WebView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-集合容器"><span class="toc-number">3.9.</span> <span class="toc-text">9.集合容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存泄漏检测工具"><span class="toc-number">4.</span> <span class="toc-text">内存泄漏检测工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>本篇对于Android中内存泄漏进行解析。<a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>相对于C/C++的内存泄漏是new出来的对象没有delete，而java中内存泄漏是new出来的对象放在Heap上无法被GC回收，所以对于内存泄漏，在开发过程中不可轻易忽视。</p>
<h2 id="杂谈"><a href="#杂谈" class="headerlink" title="杂谈"></a>杂谈</h2><p>首先谈谈Java的内存分配：</p>
<ol>
<li>静态存储区： 编译时就分配好，在程序整个运行期间都存在，主要存放静态数据和常量；</li>
<li>栈区：当方法执行时，会在栈区内存中创建方法体内部的局部变量，方法结束后自动释放内存；</li>
<li>堆区：通常用来存放new出来的对象，由java垃圾回收期回收。</li>
</ol>
<p>对于java垃圾回收机制回收不同引用类型的介绍：</p>
<ol>
<li>强引用(StrongRefrrence)： JVM宁可抛出OOM，也不会让GC回收具有强引用的对象；</li>
<li>软引用(SoftReference)：只有在内存空间不足时，才会被回收的对象；</li>
<li>弱引用(WeakReference)：在GC时，一旦发现只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存；</li>
<li>虚引用(PhantomReference)：任何时候都可以被GC回收。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之关联的引用队列中。程序可以通过判断引用队列中是否存在该对象的虚引用，来了解这个对象是否将要被回收。可以用来作为GC回收Object的标志。</li>
</ol>
<p>总结为以下：  </p>
<table>
<thead>
<tr>
<th>级别</th>
<th>回收时机</th>
<th>用途</th>
<th>生存时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>强</td>
<td>从来不会</td>
<td>对象的一般状态</td>
<td>JVM停止运行时终止</td>
</tr>
<tr>
<td>软</td>
<td>在内存不足时</td>
<td>联合ReferenceQueue构造有效期短/占内存大/生命周期长的对象的二级高速缓冲器（内存不足才清空）</td>
<td>内存不足时终止</td>
</tr>
<tr>
<td>弱</td>
<td>在垃圾回收时</td>
<td>联合ReferenceQueue构造有效期短/占内存大/生命周期长的对象的一级高速缓冲器（系统发生gc则清空）</td>
<td>gc运行后终止</td>
</tr>
<tr>
<td>虚</td>
<td>在垃圾回收时</td>
<td>联合ReferenceQueue来跟踪对象被垃圾回收器回收的活动</td>
<td>gc运行后终止</td>
</tr>
</tbody>
</table>
<h2 id="内存泄漏解析"><a href="#内存泄漏解析" class="headerlink" title="内存泄漏解析"></a>内存泄漏解析</h2><h3 id="1-持有Context"><a href="#1-持有Context" class="headerlink" title="1.持有Context"></a>1.持有Context</h3><p>context是最容易忽视的，很多情况下我们可能随意传递context，例如给一个类传递context的时候经常用Activity，但该类持有对Activity的全部引用，当Activity关闭的时候因为被其他类持有，而导致无法正常被回收，从而导致内存泄漏。</p>
<p><strong>解决方案：</strong></p>
<p>在给类传递context的时候使用Application对象，避免依赖activity的生命周期，但谨慎对context使用static关键字。</p>
<h3 id="2-Handler"><a href="#2-Handler" class="headerlink" title="2.Handler"></a>2.Handler</h3><p>Handler是最容易造成内存泄漏的，如果Handler中有延迟的任务或是等在执行的队列过长，由于消息队列持有对Handler的引用，而Handler又持有actvity的隐式引用，这个引用会保持到消息得到处理，而导致activity无法被垃圾回收器进行回收，而导致内存泄漏。  </p>
<p><strong>解决方案：</strong></p>
<ol>
<li>把Handler放到单独的类中，或者使用静态的内部类避免泄漏</li>
<li>如果想要在Handler内部去调用Activity中的资源，可以在Handler中使用弱引用的方式指向所在的Activity，使用static+WeakReference的方式断开handler与activity的关系</li>
</ol>
<h3 id="3-单例模式"><a href="#3-单例模式" class="headerlink" title="3.单例模式"></a>3.单例模式</h3><p>在使用单例模式的时候如果使用不当也是会造成内存泄漏的，因为单例膜撕的静态特征使得单例模式的生命周期和应用一样的长，这说明了当一个对象不需要使用了，而单例对象还存在该对象的引用，那么这个对象就不能正常的被回收，导致内存泄漏。</p>
<p><strong>解决方案：</strong></p>
<p>在构建单例模式时，我们经常会传入Activity的context，当Activity退出之后，单例对象还持有他的引用，所以为了避免传Activity的context，在单例中通过传入的context获取到全局的上下文对象，而不适用Activity的Context就解决了这个问题。</p>
<h3 id="4-非静态内部类创建静态实例"><a href="#4-非静态内部类创建静态实例" class="headerlink" title="4.非静态内部类创建静态实例"></a>4.非静态内部类创建静态实例</h3><p>在非静态的内部类默认会持有外部类的引用，而我们又使用非静态内部类创建了一个静态的实例，该静态实例的声明周期和应用一样长，这就导致了该静态实例一直会持有该Activity的引用，导致Activity不能正常回收。</p>
<p><strong>解决方案：</strong></p>
<ol>
<li>将内部类修改成静态的，这样它对外部类就没有引用</li>
<li>将该对象抽取出来封装成一个单例。</li>
</ol>
<h3 id="5-线程"><a href="#5-线程" class="headerlink" title="5.线程"></a>5.线程</h3><p>我们在使用线程时，一般都使用匿名内部类，而匿名内部类会对外部类持有默认的引用，当Activity关闭之后如果现成中的任务还没有执行完毕，就会导致Activity不能正常回收，造成内存泄漏。</p>
<p><strong>解决方案：</strong></p>
<p>创建一个静态的类，实现Runnable方法，在使用的时候实例化。</p>
<h3 id="6-资源未关闭"><a href="#6-资源未关闭" class="headerlink" title="6.资源未关闭"></a>6.资源未关闭</h3><p>对于使用了BroadcastReceiver、ContentObserver、File、Cursor、Stream、Bitmap等资源，应该在Activity销毁时及时关闭或者注销掉，否则这些资源不会被回收，造成内存泄漏。</p>
<h3 id="7-监听器未注销"><a href="#7-监听器未注销" class="headerlink" title="7.监听器未注销"></a>7.监听器未注销</h3><p>在很多地方需要register的监听器，要确保及时unregister监听器。</p>
<h3 id="8-WebView"><a href="#8-WebView" class="headerlink" title="8.WebView"></a>8.WebView</h3><p>webView是个坑，很难驾驭，如果你在webView有js连调中有线程处理，不再需要使用webView的时候，应该调用它的destory()销毁，释放其占用的内存，否则其占用的内存长期也不能回收，从而造成内存泄漏。</p>
<h3 id="9-集合容器"><a href="#9-集合容器" class="headerlink" title="9.集合容器"></a>9.集合容器</h3><p>我们通常会把一些对象的引用加入到集合容器（比如ArrayList）中，当我们不再需要该对象时，并没有把它的引用从集合中清理掉，这样这个集合就会越来越大。如果这个集合是static的话，那情况就更严重了。</p>
<p><strong>解决方案：</strong></p>
<p>所以在退出程序之前，将集合里面的东西clear，然后置为null，再退出程序。</p>
<h2 id="内存泄漏检测工具"><a href="#内存泄漏检测工具" class="headerlink" title="内存泄漏检测工具"></a>内存泄漏检测工具</h2><p>对于检测工具，我推荐两种：</p>
<ol>
<li><a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="external">MAT(Memory Analyzer Tool)</a>，具体使用方法网上很多。</li>
<li><a href="https://github.com/square/leakcanary" target="_blank" rel="external">LeakCanary</a>，这是我近2年一直在用的一个检测库，配置简单，抓捕率高，但某些机型上有些bug，所以开发阶段可以用，发版建议关闭。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>构造Adapter时，没有使用缓存的 convertView</li>
<li>Bitmap对象不在使用时调用recycle()释放内存</li>
<li>Context使用不当造成内存泄露：不要对一个Activity Context保持长生命周期的引用。尽量在一切可以使用应用ApplicationContext代替Context的地方进行替换。</li>
<li>非静态内部类的静态实例容易造成内存泄漏：即一个类中如果你不能够控制它其中内部类的生命周期（譬如Activity中的一些特殊Handler等），则尽量使用静态类和弱引用来处理（譬如ViewRoot的实现）。</li>
<li>警惕线程未终止造成的内存泄露；譬如在Activity中关联了一个生命周期超过Activity的Thread，在退出Activity时切记结束线程。一个典型的例子就是HandlerThread的run方法是一个死循环，它不会自己结束，线程的生命周期超过了Activity生命周期，我们必须手动在Activity的销毁方法中中调运thread.getLooper().quit();才不会泄露。</li>
<li>对象的注册与反注册没有成对出现造成的内存泄露；譬如注册广播接收器、注册观察者（典型的譬如数据库的监听）等。</li>
<li>创建与关闭没有成对出现造成的泄露；譬如Cursor资源必须手动关闭，WebView必须手动销毁，流等对象必须手动关闭等。</li>
<li>不要在执行频率很高的方法或者循环中创建对象（比如onmeasure），可以使用HashTable等创建一组对象容器从容器中取那些对象，而不用每次new与释放。</li>
<li>避免代码设计模式的错误造成内存泄露；譬如循环引用，A持有B，B持有C，C持有A，这样的设计谁都得不到释放。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://blog.csdn.net/imuhao/article/details/51694144" target="_blank" rel="external">Android内存泄漏解决方案(OOM)</a></li>
<li><a href="http://www.cnblogs.com/liushilin/p/5900089.html" target="_blank" rel="external">内存泄漏全解析，从此拒绝ANR，让OOM远离你的身边，跟内存泄漏say byebye</a></li>
</ol>
</div><div class="tags"><a href="/tags/内存/">内存</a></div><div class="post-nav"><a href="/2017/04/20/Mac-JDK-Change/" class="pre">Mac JDK版本切换</a><a href="/2017/01/16/Android-DownloadManager/" class="next">使用DownloadManager进行版本更新（兼容7.0）</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'f1reking';
var disqus_identifier = '2017/03/01/memory-leak-analysis/';
var disqus_title = '内存泄漏解析';
var disqus_url = 'http://f1reking.com/2017/03/01/memory-leak-analysis/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//f1reking.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://f1reking.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/器-工具使用/">器.工具使用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/域-业务领域/">域.业务领域</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技-技术研究/">技.技术研究</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/术-解决方案/">术.解决方案</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/法-手段方法/">法.手段方法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/理-理论学习/">理.理论学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生-人生随笔/">生.人生随笔</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Android-Studio/" style="font-size: 15px;">Android Studio</a> <a href="/tags/规范/" style="font-size: 15px;">规范</a> <a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/SDK/" style="font-size: 15px;">SDK</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Service/" style="font-size: 15px;">Service</a> <a href="/tags/GreenDAO/" style="font-size: 15px;">GreenDAO</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/RxJava/" style="font-size: 15px;">RxJava</a> <a href="/tags/WebView/" style="font-size: 15px;">WebView</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/07/android-webview-keng/">关于Android7.0使用webview遇到的一个坑</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/05/android-emotion/">文字中表情的解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/20/Mac-JDK-Change/">Mac JDK版本切换</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/01/memory-leak-analysis/">内存泄漏解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/16/Android-DownloadManager/">使用DownloadManager进行版本更新（兼容7.0）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/16/UMeng-package/">快速集成友盟多渠道打包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/31/Bye2016Hi2017/">Bye2016Hi2017</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/01/Android-shape/">Android中shape的特性详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/Android-edittext/">Android中EditText的一切</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/28/Android-sdk-pay/">Android接入支付SDK</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//f1reking.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a><ul></ul><a href="http://wuxiaolong.me/" title="吴小龙同学" target="_blank">吴小龙同学</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">F1ReKing Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>